name: Tests

on:
  push:
  workflow_dispatch:

jobs:
  test-linux:
    name: Build and Test (Linux)
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04]
        cc: [gcc, clang]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Compiler Version
        run: |
          ${{ matrix.cc }} --version
          make --version

      - name: Build hash
        run: |
          make clean
          CC=${{ matrix.cc }} make

      - name: Check Binary
        run: |
          ls -lh hash-shell
          file hash-shell

      - name: Make Test Script Executable
        run: chmod +x test.sh

      - name: Run Tests
        run: ./test.sh

      - name: Run Unit Tests
        run: make test

      - name: Test Different Optimization Levels
        run: |
          make clean
          make CC=${{ matrix.cc }} CFLAGS="-Wall -Wextra -O0 -std=gnu99 -g"
          ./test.sh
          make test-clean
          make test

  test-macos:
    name: Build and Test (macOS)
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-latest, macos-14, macos-15, macos-26]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Compiler Version
        run: |
          clang --version
          make --version

      - name: Build hash
        run: |
          make clean
          CC=clang make

      - name: Check Binary
        run: |
          ls -lh hash-shell
          file hash-shell

      - name: Make Test Script Executable
        run: chmod +x test.sh

      - name: Run Tests
        run: ./test.sh

      - name: Run Unit Tests
        run: make test

  test-freebsd:
    name: Build and Test (FreeBSD)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build and Test on FreeBSD
        uses: cross-platform-actions/action@v0.27.0
        with:
          operating_system: freebsd
          version: '14.2'
          shell: sh
          run: |
            set -e
            uname -a
            
            # Install GNU make
            sudo pkg install -y gmake
            
            cc --version
            gmake --version

            # Build
            gmake clean || true
            gmake CC=cc

            # Check binary
            ls -lh hash-shell
            file hash-shell

            # Run the shell briefly to test it works
            echo "echo 'Hello from FreeBSD'" | ./hash-shell

            # Run unit tests (must pass CC=cc for FreeBSD)
            gmake CC=cc test

  build-check:
    name: Build Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check Compiler Warnings
        run: |
          make clean
          make CFLAGS="-Wall -Wextra -Werror -O2 -std=gnu99"

      - name: Check Code Formatting
        run: |
          # Check for trailing whitespace
          ! git grep -n '[[:space:]]$' -- '*.c' '*.h'

      - name: Verify Clean Rebuild
        run: |
          make clean
          make
          make clean
          make

  build-check-macos:
    name: Build Validation (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check Compiler Warnings
        run: |
          make clean
          make CFLAGS="-Wall -Wextra -Werror -O2 -std=gnu99"

      - name: Verify Clean Rebuild
        run: |
          make clean
          make
          make clean
          make

  build-check-freebsd:
    name: Build Validation (FreeBSD)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check Compiler Warnings on FreeBSD
        uses: cross-platform-actions/action@v0.27.0
        with:
          operating_system: freebsd
          version: '14.2'
          shell: sh
          run: |
            set -e
            
            # Install GNU make
            sudo pkg install -y gmake
            
            gmake clean || true
            gmake CC=cc CFLAGS="-Wall -Wextra -Werror -O2 -std=gnu99"

            # Verify clean rebuild
            gmake clean
            gmake CC=cc
            gmake clean
            gmake CC=cc

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build With Security Flags
        run: |
          make clean
          make CFLAGS="-Wall -Wextra -O2 -std=gnu99 -D_FORTIFY_SOURCE=2 -fstack-protector-strong"

      - name: Run Security Checks
        run: |
          echo "Checking for unsafe functions..."
          ! git grep -n 'gets\|strcpy\|strcat\|sprintf' -- '*.c' || echo "Warning: Found potentially unsafe functions"
